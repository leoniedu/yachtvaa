---
title: "Morning Session Analysis: 2026-01-29"
subtitle: "Yacht Club da Bahia -- Paddler Performance vs. Wind & Current"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse   = TRUE,
  comment    = "#>",
  fig.width  = 8,
  fig.height = 5,
  dpi        = 150,
  warning    = FALSE,
  message    = FALSE
)
```

This report analyses the morning paddling session at Yacht Club da Bahia on
**29 January 2026**.  It downloads GPS tracks from the Treinus platform and
environmental data from SIMCOSTA buoy 515, then computes the fastest 500 m
straight-line efforts and examines how wind and current shaped each
performance.

## 1 -- Packages

```{r packages}
library(yachtvaa)
library(dplyr)
library(sf)
library(ggplot2)
library(lubridate)
```

## 2 -- Data acquisition

```{r auth}
session <- treinusr::treinus_auth()
```

Download paddler GPS records and SIMCOSTA buoy 515 data in one call.
The buoy time window is automatically padded by one hour on each side of
the session.

```{r download}
raw <- fetch_session_data(
  session,
  date       = "2026-01-29",
  start_time = "00:00",
  end_time   = "12:00",
  athlete_ids = 1:70
)

records <- raw$records
buoy    <- raw$buoy
```

## 3 -- Who was in the water?

Not every athlete returned by Treinus actually paddled -- some may have brief
GPS traces on shore.
We keep only athletes with **at least 100 GPS fixes** and a track that spans
**more than 200 m** of cumulative movement.

```{r identify-paddlers}
records_sf <- records_to_sf(records)

track_summary <- records_sf |>
  st_drop_geometry() |>
  summarise(
    n_fixes      = n(),
    first_fix    = min(timestamp),
    last_fix     = max(timestamp),
    duration_min = as.numeric(difftime(max(timestamp), min(timestamp),
                                       units = "mins")),
    .by = c(id_athlete, fullname_athlete)
  )

# Cumulative point-to-point distance per athlete
track_distance <- records_sf |>
  arrange(id_athlete, timestamp) |>
  mutate(
    coords = st_coordinates(geometry),
    x = coords[, 1],
    y = coords[, 2],
    .keep = "unused"
  ) |>
  st_drop_geometry() |>
  summarise(
    track_distance_m = sum(sqrt(diff(x)^2 + diff(y)^2)),
    .by = id_athlete
  )

track_summary <- track_summary |>
  left_join(track_distance, by = "id_athlete")

paddlers <- track_summary |>
  filter(n_fixes >= 100, track_distance_m >= 200)

paddlers |>
  arrange(desc(track_distance_m)) |>
  mutate(
    track_distance_km = round(track_distance_m / 1000, 1),
    duration_min      = round(duration_min, 0)
  ) |>
  select(fullname_athlete, n_fixes, duration_min, track_distance_km) |>
  knitr::kable(
    col.names = c("Athlete", "GPS fixes", "Duration (min)", "Distance (km)"),
    caption   = "Athletes identified in the water"
  )
```

```{r filter-paddlers}
records_sf <- records_sf |>
  filter(id_athlete %in% paddlers$id_athlete)

n_paddlers <- nrow(paddlers)
```

## 4 -- Track map

```{r track-map, fig.height = 7, fig.cap = "GPS tracks coloured by athlete (SIRGAS 2000 / UTM 24S)."}
ggplot(records_sf) +
  geom_sf(aes(colour = fullname_athlete), size = 0.3, alpha = 0.6) +
  scale_colour_viridis_d(option = "turbo") +
  labs(
    title  = "GPS tracks -- 29 Jan 2026 morning session",
    colour = "Athlete"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    legend.title    = element_text(size = 9),
    legend.text     = element_text(size = 7)
  ) +
  guides(colour = guide_legend(nrow = 3, override.aes = list(size = 2)))
```

## 5 -- Fastest 500 m

```{r fastest-500}
fast500 <- fastest_straight_distance(
  records_sf,
  athlete_col = "id_athlete",
  time_col    = "timestamp",
  distance_m  = 500
)

# Attach athlete names
fast500 <- fast500 |>
  left_join(
    paddlers |> select(id_athlete, fullname_athlete),
    by = "id_athlete"
  )
```

```{r fastest-500-bar, fig.cap = "Fastest predicted 500 m times, sorted from fastest to slowest."}
fast500 |>
  mutate(
    fullname_athlete = forcats::fct_reorder(fullname_athlete,
                                            predicted_time_sec),
    time_label = sprintf("%d:%04.1f",
                         floor(predicted_time_sec / 60),
                         predicted_time_sec %% 60)
  ) |>
  ggplot(aes(x = predicted_time_sec, y = fullname_athlete)) +
  geom_col(aes(fill = avg_speed_kmh), width = 0.7) +
  geom_text(aes(label = time_label), hjust = -0.1, size = 3) +
  scale_fill_viridis_c(option = "plasma", name = "Avg speed\n(km/h)") +
  scale_x_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Fastest 500 m -- 29 Jan 2026",
    x     = "Predicted time (seconds)",
    y     = NULL
  ) +
  theme_minimal(base_size = 11)
```

### Fastest-segment geometry

```{r fastest-map, fig.height = 7, fig.cap = "Straight-line segments of the fastest 500 m effort per athlete overlaid on all GPS points."}
fast500_sf <- fastest_straight_geometry(fast500)

ggplot() +
  geom_sf(data = records_sf, colour = "grey80", size = 0.15, alpha = 0.4) +
  geom_sf(
    data = fast500_sf,
    aes(colour = fullname_athlete),
    linewidth = 1.2
  ) +
  scale_colour_viridis_d(option = "turbo") +
  labs(
    title    = "Fastest 500 m segments",
    subtitle = "Straight-line paths overlaid on all GPS points",
    colour   = "Athlete"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    legend.text     = element_text(size = 7)
  ) +
  guides(colour = guide_legend(nrow = 3, override.aes = list(linewidth = 1.5)))
```

## 6 -- Buoy conditions during the session

Interpolate the buoy data to a regular 10-minute grid.

```{r buoy-interp}
buoy_ip <- interpolate_buoy(buoy)
```

### Wind

```{r wind-available}
has_wind <- "wind_speed" %in% names(buoy_ip) &&
  any(!is.na(buoy_ip$wind_speed))
```

```{r wind-ts, eval = has_wind, fig.height = 6, fig.cap = "Wind speed and direction recorded by SIMCOSTA buoy 515."}
buoy_wind <- buoy_ip |>
  filter(!is.na(wind_speed)) |>
  mutate(
    wind_speed_kmh = wind_speed * 3.6,
    local_time     = with_tz(datetime, tzone = "America/Bahia")
  )

p_speed <- ggplot(buoy_wind, aes(local_time, wind_speed_kmh)) +
  geom_line(linewidth = 0.8, colour = "#0072B2") +
  geom_point(size = 1.5, colour = "#0072B2") +
  labs(y = "Wind speed (km/h)", x = NULL, title = "Wind conditions") +
  theme_minimal(base_size = 11)

p_dir <- ggplot(buoy_wind, aes(local_time, wind_direction)) +
  geom_line(linewidth = 0.8, colour = "#D55E00") +
  geom_point(size = 1.5, colour = "#D55E00") +
  scale_y_continuous(
    limits = c(0, 360),
    breaks = seq(0, 360, 90),
    labels = c("N", "E", "S", "W", "N")
  ) +
  labs(y = "Wind direction (from)", x = "Local time (America/Bahia)") +
  theme_minimal(base_size = 11)

gridExtra::grid.arrange(p_speed, p_dir, ncol = 1)
```

```{r wind-missing-note, eval = !has_wind, results = "asis"}
cat("**No wind data available for this session.** Wind will be treated as zero.\n")
```

### Current

```{r current-ts, fig.height = 6, fig.cap = "Current speed and direction recorded by buoy 515."}
buoy_current <- buoy_ip |>
  filter(!is.na(current_speed_kmh)) |>
  mutate(local_time = with_tz(datetime, tzone = "America/Bahia"))

p_cspeed <- ggplot(buoy_current, aes(local_time, current_speed_kmh)) +
  geom_line(linewidth = 0.8, colour = "#009E73") +
  geom_point(size = 1.5, colour = "#009E73") +
  labs(y = "Current speed (km/h)", x = NULL, title = "Current conditions") +
  theme_minimal(base_size = 11)

p_cdir <- ggplot(buoy_current, aes(local_time, current_direction)) +
  geom_line(linewidth = 0.8, colour = "#CC79A7") +
  geom_point(size = 1.5, colour = "#CC79A7") +
  scale_y_continuous(
    limits = c(0, 360),
    breaks = seq(0, 360, 90),
    labels = c("N", "E", "S", "W", "N")
  ) +
  labs(y = "Current direction (to)", x = "Local time (America/Bahia)") +
  theme_minimal(base_size = 11)

gridExtra::grid.arrange(p_cspeed, p_cdir, ncol = 1)
```

## 7 -- Match conditions to fastest segments

Rename the buoy columns to the names `apparent_conditions()` expects, then
match each segment to the nearest buoy observation via rolling join.

```{r match-buoy}
buoy_for_match <- buoy_ip |>
  transmute(
    datetime,
    wind_direction_deg    = if ("wind_direction" %in% names(buoy_ip))
      wind_direction else NA_real_,
    wind_speed_kmh        = if ("wind_speed" %in% names(buoy_ip))
      wind_speed * 3.6 else NA_real_,
    current_direction_deg = current_direction,
    current_speed_kmh     = current_speed_kmh,
    wave_height,
    wave_direction
  )

matched <- match_buoy_to_segments(fast500, buoy_for_match)
```

Compute relative wind / current angles and along-track components.
When wind data is unavailable it is imputed as zero.

```{r apparent}
conditions <- apparent_conditions(matched, impute_missing_wind = !has_wind)
```

### Wind relative to each fastest effort

```{r wind-class-bar, fig.cap = "Wind classification for each athlete's fastest 500 m segment."}
conditions |>
  as_tibble() |>
  mutate(
    fullname_athlete = forcats::fct_reorder(fullname_athlete,
                                            predicted_time_sec)
  ) |>
  ggplot(aes(y = fullname_athlete, x = wind_component_kmh,
             fill = wind_class)) +
  geom_col(width = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = "grey40") +
  scale_fill_manual(
    values = c(
      headwind        = "#E63946",
      tailwind        = "#2A9D8F",
      crosswind_left  = "#457B9D",
      crosswind_right = "#F4A261"
    ),
    name = "Wind class"
  ) +
  labs(
    title    = "Along-track wind component per athlete",
    subtitle = "Negative = opposing (headwind), positive = assisting (tailwind)",
    x = "Wind component (km/h)",
    y = NULL
  ) +
  theme_minimal(base_size = 11)
```

### Current relative to each fastest effort

```{r current-class-bar, fig.cap = "Current classification for each athlete's fastest 500 m segment."}
conditions |>
  as_tibble() |>
  mutate(
    fullname_athlete = forcats::fct_reorder(fullname_athlete,
                                            predicted_time_sec)
  ) |>
  ggplot(aes(y = fullname_athlete, x = current_component_kmh,
             fill = current_class)) +
  geom_col(width = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = "grey40") +
  scale_fill_manual(
    values = c(
      following   = "#2A9D8F",
      opposing    = "#E63946",
      cross_left  = "#457B9D",
      cross_right = "#F4A261"
    ),
    name = "Current class"
  ) +
  labs(
    title    = "Along-track current component per athlete",
    subtitle = "Negative = opposing, positive = following",
    x = "Current component (km/h)",
    y = NULL
  ) +
  theme_minimal(base_size = 11)
```

### Segment bearing vs. wind & current direction

A **polar plot** showing each athlete's fastest-segment bearing alongside the
prevailing wind (FROM) and current (TO) direction at that time.

```{r bearing-polar, fig.height = 6, fig.cap = "Polar plot of segment bearing (blue), wind-from (red arrows), and current-to (green arrows)."}
polar_df <- conditions |>
  as_tibble() |>
  transmute(
    fullname_athlete,
    bearing_deg,
    wind_direction_deg,
    current_direction_deg,
    avg_speed_kmh
  )

ggplot(polar_df) +
  geom_point(
    aes(x = bearing_deg, y = avg_speed_kmh),
    colour = "#0072B2", size = 3
  ) +
  ggrepel::geom_text_repel(
    aes(x = bearing_deg, y = avg_speed_kmh,
        label = fullname_athlete),
    size = 2.5, max.overlaps = 20
  ) +
  # Wind FROM arrows (pointing inward from edge)
  geom_spoke(
    aes(x = wind_direction_deg, y = max(avg_speed_kmh) * 1.25,
        angle = -(wind_direction_deg - 90) * pi / 180),
    radius = -max(polar_df$avg_speed_kmh) * 0.3,
    arrow  = arrow(length = unit(0.15, "cm")),
    colour = "#E63946", linewidth = 0.6
  ) +
  # Current TO arrows (pointing outward from centre)
  geom_spoke(
    aes(x = current_direction_deg, y = 0,
        angle = -(current_direction_deg - 90) * pi / 180),
    radius = max(polar_df$avg_speed_kmh) * 0.3,
    arrow  = arrow(length = unit(0.15, "cm")),
    colour = "#009E73", linewidth = 0.6
  ) +
  coord_polar(start = -pi / 2, direction = -1) +
  scale_x_continuous(
    limits = c(0, 360),
    breaks = seq(0, 315, 45),
    labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")
  ) +
  labs(
    title    = "Segment heading, wind & current directions",
    subtitle = "Blue = athlete heading & speed; Red = wind FROM; Green = current TO",
    x = NULL,
    y = "Speed (km/h)"
  ) +
  theme_minimal(base_size = 11)
```

## 8 -- Speed vs. environmental assistance

Do athletes who had a net environmental boost (tailwind + following current)
show faster times?

```{r speed-vs-env, fig.cap = "Predicted 500 m time vs. net environmental component (wind + current)."}
conditions |>
  as_tibble() |>
  mutate(total_env_kmh = wind_component_kmh + current_component_kmh) |>
  ggplot(aes(x = total_env_kmh, y = predicted_time_sec)) +
  geom_point(aes(colour = avg_speed_kmh), size = 3) +
  ggrepel::geom_text_repel(
    aes(label = fullname_athlete), size = 2.5, max.overlaps = 20
  ) +
  geom_smooth(method = "lm", se = TRUE, colour = "grey40",
              linetype = "dashed", linewidth = 0.6) +
  scale_colour_viridis_c(option = "plasma", name = "Avg speed\n(km/h)") +
  labs(
    title = "Does environmental assistance predict faster times?",
    x     = "Net environmental component (km/h)",
    y     = "Predicted 500 m time (sec)"
  ) +
  theme_minimal(base_size = 11)
```

## 9 -- League table

```{r league}
league <- build_league_table(conditions, athlete_col = "fullname_athlete")
league_fmt <- format_league(league, top_n = 15)

league_fmt |>
  select(
    rank, fullname_athlete, predicted_time_fmt, avg_speed_kmh,
    wind_class, wind_component_kmh,
    current_class, current_component_kmh
  ) |>
  mutate(
    avg_speed_kmh         = round(avg_speed_kmh, 1),
    wind_component_kmh    = round(wind_component_kmh, 1),
    current_component_kmh = round(current_component_kmh, 1)
  ) |>
  knitr::kable(
    col.names = c(
      "Rank", "Athlete", "Time", "Speed (km/h)",
      "Wind", "Wind (km/h)", "Current", "Current (km/h)"
    ),
    caption = "League table: fastest 500 m on 29 Jan 2026"
  )
```

## 10 -- Session summary

```{r summary-stats, results = "asis"}
current_summary <- buoy_current |>
  summarise(
    mean_speed = round(mean(current_speed_kmh, na.rm = TRUE), 2),
    max_speed  = round(max(current_speed_kmh, na.rm = TRUE), 2),
    mean_dir   = round(mean(current_direction, na.rm = TRUE), 0)
  )

winner      <- league_fmt$fullname_athlete[1]
winner_time <- league_fmt$predicted_time_fmt[1]
winner_kmh  <- round(league_fmt$avg_speed_kmh[1], 1)

if (has_wind) {
  wind_summary <- buoy_wind |>
    summarise(
      mean_speed = round(mean(wind_speed_kmh, na.rm = TRUE), 1),
      max_speed  = round(max(wind_speed_kmh, na.rm = TRUE), 1),
      mean_dir   = round(mean(wind_direction, na.rm = TRUE), 0)
    )
  wind_line <- sprintf(
    "- **Wind:** mean %s km/h (max %s), prevailing from %s\u00b0",
    wind_summary$mean_speed, wind_summary$max_speed, wind_summary$mean_dir
  )
} else {
  wind_line <- "- **Wind:** no data available (imputed as zero)"
}

cat(sprintf(
  "**Session overview:**\n\n
- **Date:** 2026-01-29
- **Athletes in the water:** %d
%s
- **Current:** mean %s km/h (max %s), flowing towards %s\u00b0
- **Fastest 500 m:** %s in %s (%s km/h)\n",
  n_paddlers,
  wind_line,
  current_summary$mean_speed, current_summary$max_speed, current_summary$mean_dir,
  winner, winner_time, winner_kmh
))
```
