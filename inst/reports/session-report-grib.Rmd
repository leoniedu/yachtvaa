---
title: "`r format(as.Date(params$date), 'Resumo do Treino de %d/%m/%Y')`"
subtitle: "Yacht Club da Bahia -- Desempenho vs. Corrente e Vento"
output:
  html_document:
    theme: flatly
params:
  date: "2026-02-03"
  start_time: "01:00"
  end_time: "10:00"
  athlete_ids: !expr 1:70
  cache: true

---

```{r setup, include = FALSE}
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
Sys.setlocale("LC_TIME", "pt_BR.UTF-8")
knitr::opts_chunk$set(
  echo       = FALSE,
  collapse   = TRUE,
  comment    = "#>",
  fig.width  = 8,
  fig.height = 5,
  dpi        = 150,
  warning    = FALSE,
  message    = FALSE
)

session_date  <- as.Date(params$date)
date_label    <- format(session_date, "%d/%m/%Y")
date_long     <- format(session_date, "%d de %B de %Y")
date_short    <- format(session_date, "%d %b %Y")
```

```{r packages, include = FALSE}
library(yachtvaa)
library(dplyr)
library(tidyr)
library(sf)
library(ggplot2)
library(patchwork)
library(lubridate)
library(terra)
```

```{r download, include = FALSE}
if (!params$cache) {
 session <- treinusr::treinus_auth()
}
use_cache <- params$cache
raw <- fetch_session_data(
  session = session,
  date        = params$date,
  start_time  = params$start_time,
  end_time    = params$end_time,
  athlete_ids = params$athlete_ids,
  cache       = use_cache,
  overwrite_db=!use_cache,
  use_memoise=FALSE
)

records <- raw$records |>
  mutate(fullname_athlete = capitalizar(fullname_athlete))
buoy    <- raw$buoy

# Filtro espacial
records_sf <- records_to_sf(records)
study_area <- sf::st_bbox(
  c(xmin = -38.61380, ymin = -13.00741,
    xmax = -38.46308, ymax = -12.81308),
  crs = 4326L
) |>
  sf::st_as_sfc() |>
  sf::st_transform(sf::st_crs(records_sf))

athletes_in_bbox <- records_sf[
  lengths(sf::st_intersects(records_sf, study_area)) > 0,
  "id_athlete"
]

records_sf <- records_sf[records_sf$id_athlete %in% athletes_in_bbox$id_athlete, ]

records_sf_bbox <- records_sf[
  lengths(sf::st_intersects(records_sf, study_area)) > 0,
]
```

```{r grib-read, include = FALSE}
# Read SISCORAR ocean current model (U and V components, hourly)
cache_grib <- TRUE
grib_path <- "~/tmp/tmp.grib2"
if (!cache_grib) { 
library(rsiscorar)
siscorar <- rsiscorar::predict_currents(date = params$date, area = "baiatos", daylight_saving = FALSE)
write_grib(siscorar, normalizePath(grib_path), hours = 0:23, resolution = 0.001)
  }

grib <- terra::rast(grib_path)

# Identify U and V layers from names
layer_names <- names(grib)
is_u <- grepl("u-component|UOGRD", layer_names, ignore.case = TRUE)
is_v <- grepl("v-component|VOGRD", layer_names, ignore.case = TRUE)
stopifnot(
  "Expected U and V layers in GRIB" = any(is_u) && any(is_v),
  "Expected equal number of U and V layers" = sum(is_u) == sum(is_v)
)

u_layers <- grib[[which(is_u)]]
v_layers <- grib[[which(is_v)]]
n_hours  <- terra::nlyr(u_layers)

# Hourly timestamps (00:00 to 23:00 UTC)
grib_times <- as.POSIXct(
  paste(params$date, sprintf("%02d:00:00", seq(0, n_hours - 1))),
  tz = "UTC"
)

# Crop to combined extent of study_area + records (in WGS84)
study_bbox_4326 <- sf::st_bbox(sf::st_transform(study_area, 4326))
records_bbox_4326 <- sf::st_bbox(sf::st_transform(records_sf, 4326))
combined_bbox <- c(
  xmin = min(study_bbox_4326["xmin"], records_bbox_4326["xmin"]),
  xmax = max(study_bbox_4326["xmax"], records_bbox_4326["xmax"]),
  ymin = min(study_bbox_4326["ymin"], records_bbox_4326["ymin"]),
  ymax = max(study_bbox_4326["ymax"], records_bbox_4326["ymax"])
)
study_ext <- terra::ext(
  combined_bbox["xmin"], combined_bbox["xmax"],
  combined_bbox["ymin"], combined_bbox["ymax"]
)
u_study <- terra::crop(u_layers, study_ext)
v_study <- terra::crop(v_layers, study_ext)

```

```{r buoy-wind-setup, include = FALSE}
# Buoy data: wind + current from SIMCOSTA (GRIB provides SISCORAR currents)
buoy_ip <- interpolate_buoy(buoy)

has_wind <- "wind_speed" %in% names(buoy_ip) &&
  any(!is.na(buoy_ip$wind_speed))

has_buoy_current <- "current_speed_kmh" %in% names(buoy_ip) &&
  any(!is.na(buoy_ip$current_speed_kmh))

records_time_range <- range(records_sf$timestamp)

if (has_wind) {
  buoy_wind <- buoy_ip |>
    filter(
      datetime >= records_time_range[1],
      datetime <= records_time_range[2],
      !is.na(wind_speed)
    ) |>
    mutate(
      wind_speed_kmh = wind_speed * 3.6,
      local_time     = with_tz(datetime, tzone = "America/Bahia")
    )
}

if (has_buoy_current) {
  buoy_current <- buoy_ip |>
    filter(
      datetime >= records_time_range[1],
      datetime <= records_time_range[2],
      !is.na(current_speed_kmh)
    ) |>
    mutate(local_time = with_tz(datetime, tzone = "America/Bahia"))
}
```

### Atletas

```{r identify-paddlers}
track_summary <- records_sf |>
  st_drop_geometry() |>
  summarise(
    n_fixes      = n(),
    first_fix    = min(timestamp),
    last_fix     = max(timestamp),
    duration_min = as.numeric(difftime(max(timestamp), min(timestamp),
                                       units = "mins")),
    .by = c(id_athlete, fullname_athlete)
  )

track_distance <- records_sf |>
  arrange(id_athlete, timestamp) |>
  mutate(
    coords = st_coordinates(geometry),
    x = coords[, 1],
    y = coords[, 2],
    .keep = "unused"
  ) |>
  st_drop_geometry() |>
  summarise(
    track_distance_m = sum(sqrt(diff(x)^2 + diff(y)^2)),
    .by = id_athlete
  )

track_summary <- track_summary |>
  left_join(track_distance, by = "id_athlete")

paddlers <- track_summary |>
  filter(n_fixes >= 100, track_distance_m >= 200)

paddlers |>
  arrange(desc(track_distance_m)) |>
  mutate(
    track_distance_km = round(track_distance_m / 1000, 1),
    duration_fmt = sprintf("%d:%02d", floor(duration_min / 60), round(duration_min %% 60)),
    speed_kmh = round((track_distance_m / duration_min) * 60 / 1000, 1),
    first_fix=format.Date(first_fix, "%H:%M")
  ) |>
  select(fullname_athlete, first_fix, duration_fmt, track_distance_km, speed_kmh) |>
  gt::gt() |>
  gt::cols_label(
    fullname_athlete = "Atleta",
    first_fix = "Início",
    duration_fmt = "Duração (h:mm)",
    track_distance_km = "Distância (km)",
    speed_kmh = "Vel. (km/h)"
  ) |>
  gt::tab_caption("Atletas identificados na água") |>
  gt::tab_options(
    table.font.size = gt::px(12),
    data_row.padding = gt::px(2),
    column_labels.padding = gt::px(4)
  ) |>
  gt::opt_interactive(page_size_default = 100)
```

```{r filter-paddlers, include = FALSE}
records_sf <- records_sf |>
  filter(id_athlete %in% paddlers$id_athlete)

n_paddlers <- nrow(paddlers)
```

```{r fastest-500, include = FALSE}
fast500 <- fastest_straight_distance(
  records_sf_bbox,
  athlete_col = "id_athlete",
  time_col    = "timestamp",
  distance_m  = 500
)

if (nrow(fast500) > 0) {
  start_points <- sf::st_as_sf(
    fast500,
    coords = c("start_x", "start_y"),
    crs = sf::st_crs(records_sf)
  )
  end_points <- sf::st_as_sf(
    fast500,
    coords = c("end_x", "end_y"),
    crs = sf::st_crs(records_sf)
  )

  start_in_bbox <- lengths(sf::st_intersects(start_points, study_area)) > 0
  end_in_bbox <- lengths(sf::st_intersects(end_points, study_area)) > 0

  fast500 <- fast500[start_in_bbox & end_in_bbox, ]
}

fast500 <- fast500 |>
  left_join(
    paddlers |> select(id_athlete, fullname_athlete),
    by = "id_athlete"
  )
```

### Mapa

```{r fastest-map, fig.height = 8.6, fig.width = 13.8, fig.cap = "Trechos mais rápidos de 500 m em linha reta. Setas indicam a direção do percurso."}
arrow_df <- fast500 |>
  as_tibble()

basemap <- maptiles::get_tiles(records_sf, provider = "CartoDB.Positron",
                               crop = FALSE, verbose = FALSE)


```



```{r current-field, fig.height = 8.6, fig.width = 13.8, fig.cap = "Campo de correntes oceânicas SISCORAR. Setas indicam direção e intensidade."}
# Representative hour: median of training period
med_hour_utc <- as.numeric(format(
  median(records_sf$timestamp), "%H", tz = "UTC"
))
med_hour_idx <- min(max(med_hour_utc, 0), n_hours - 1) + 1

# Project to UTM for consistent overlay with track data, crop to records extent
records_ext <- terra::ext(sf::st_bbox(records_sf)[c("xmin", "xmax", "ymin", "ymax")])
u_utm <- terra::project(u_study[[med_hour_idx]], paste0("EPSG:", 31984L)) |>
  terra::crop(records_ext)
v_utm <- terra::project(v_study[[med_hour_idx]], paste0("EPSG:", 31984L)) |>
  terra::crop(records_ext)

# Aggregate to reduce arrow density (~x coarser)
u_agg <- terra::aggregate(u_utm, fact = 4, fun = "mean", na.rm = TRUE)
v_agg <- terra::aggregate(v_utm, fact = 4, fun = "mean", na.rm = TRUE)

current_df <- tibble::tibble(
  x = terra::crds(u_agg, na.rm = FALSE)[, 1],
  y = terra::crds(u_agg, na.rm = FALSE)[, 2],
  u = terra::values(u_agg)[, 1],
  v = terra::values(v_agg)[, 1]
) |>
  filter(!is.na(u), !is.na(v)) |>
  mutate(
    speed_kmh = sqrt(u^2 + v^2) * 3.6,
    arrow_scale = 800,
    xend = x + u * arrow_scale,
    yend = y + v * arrow_scale
  )

local_hour <- format(
  with_tz(grib_times[med_hour_idx], "America/Bahia"), "%Hh"
)


```



```{r}
ggplot() +
  tidyterra::geom_spatraster_rgb(data = basemap) +

  geom_sf(data = records_sf, colour = "grey50", size = 0.1, alpha = 0.4) +

  ## ----------------------------
  ## Trechos mais rápidos (atletas)
  ## ----------------------------
  geom_segment(
    data = arrow_df,
    aes(x = start_x, y = start_y,
        xend = end_x, yend = end_y,
        colour = avg_speed_kmh),
    arrow = arrow(length = unit(0.3, "cm"), type = "closed"),
    linewidth = 1.3
  ) +

  ggrepel::geom_text_repel(
    data = arrow_df,
    aes(x = (start_x + end_x) / 2,
        y = (start_y + end_y) / 2,
        label = fullname_athlete),
    size = 2.5, max.overlaps = 20,
    bg.color = "white", bg.r = 0.15
  ) +

  scale_colour_viridis_c(
    option = "plasma",
    name   = "Velocidade atleta (km/h)"
  ) +

  ## inicia nova escala de cor
  ggnewscale::new_scale_colour() +

  ## ----------------------------
  ## Campo de corrente (SISCORAR)
  ## ----------------------------
  geom_segment(
    data = current_df,
    aes(x = x, y = y,
        xend = xend, yend = yend,
        colour = speed_kmh),
    arrow = arrow(length = unit(0.12, "cm"), type = "closed"),
    linewidth = 0.5,
    alpha = 0.8
  ) +

  scale_colour_viridis_c(
    option = "mako",
    name   = "Corrente (km/h)"
  ) +

  coord_sf(crs = sf::st_crs(records_sf)) +

  labs(
    title    = "Trechos mais rápidos (500 m) e campo de correntes",
    subtitle = paste0(
      "Setas grossas = atletas | Setas finas = corrente (",
      local_hour, ")"
    )
  ) +

  theme_void(base_size = 11) +
  theme(
    legend.position = "bottom",
    plot.title      = element_text(face = "bold"),
    plot.margin     = margin(5, 5, 5, 5)
  )

```

### Condições Ambientais

```{r env-table, echo = FALSE}
# SISCORAR: study-area average current per hour
u_means <- terra::global(u_study, "mean", na.rm = TRUE)$mean
v_means <- terra::global(v_study, "mean", na.rm = TRUE)$mean

grib_hourly <- tibble::tibble(
  datetime         = grib_times,
  current_speed_kmh = sqrt(u_means^2 + v_means^2) * 3.6,
  current_direction = (atan2(u_means, v_means) * 180 / pi) %% 360
) |>
  mutate(
    local_time = with_tz(datetime, "America/Bahia"),
    hour = format(floor_date(local_time, "hour"), "%Hh")
  )

# Filter to training period
grib_training <- grib_hourly |>
  filter(
    datetime >= floor_date(records_time_range[1], "hour"),
    datetime <= ceiling_date(records_time_range[2], "hour") 
  )

current_h <- grib_training |>
  summarise(
    speed = round(mean(current_speed_kmh, na.rm = TRUE), 1),
    dir   = round(mean(current_direction, na.rm = TRUE), 0),
    .by = hour
  ) |>
  arrange(hour)

dir_arrow <- function(deg, from = FALSE) {
  if (from) deg <- (deg + 180) %% 360
  arrows <- c("\u2191", "\u2197", "\u2192", "\u2198",
              "\u2193", "\u2199", "\u2190", "\u2196")
  ifelse(is.na(deg), "\u2014", arrows[(round(deg / 45) %% 8) + 1])
}

# SISCORAR current metrics
metrics_long <- bind_rows(
  tibble(hour = current_h$hour, metric = "SISCORAR (km/h)",
         value = as.character(current_h$speed)),
  tibble(hour = current_h$hour, metric = "Dir. SISCORAR",
         value = dir_arrow(current_h$dir))
)

# Buoy data: wind + current (hourly summaries)
buoy_local <- buoy_ip |>
  mutate(
    local_time = with_tz(datetime, "America/Bahia"),
    hour = format(floor_date(local_time, "hour"), "%Hh")
  ) |>
  filter(
    datetime >= floor_date(records_time_range[1], "hour") - hours(1),
    datetime <= ceiling_date(records_time_range[2], "hour") + hours(1)
  )

if (has_buoy_current) {
  buoy_current_h <- buoy_local |>
    filter(!is.na(current_speed_kmh)) |>
    summarise(
      speed = round(mean(current_speed_kmh, na.rm = TRUE), 1),
      dir   = round(mean(current_direction, na.rm = TRUE), 0),
      .by = hour
    ) |>
    arrange(hour)

  metrics_long <- bind_rows(
    metrics_long,
    tibble(hour = buoy_current_h$hour, metric = "Boia (km/h)",
           value = as.character(buoy_current_h$speed)),
    tibble(hour = buoy_current_h$hour, metric = "Dir. Boia",
           value = dir_arrow(buoy_current_h$dir))
  )
}

if (has_wind) {
  wind_h <- buoy_local |>
    filter(!is.na(wind_speed)) |>
    summarise(
      speed = round(mean(wind_speed * 3.6, na.rm = TRUE), 0),
      dir   = round(mean(wind_direction, na.rm = TRUE), 0),
      .by = hour
    ) |>
    arrange(hour)

  metrics_long <- bind_rows(
    tibble(hour = wind_h$hour, metric = "Vento (km/h)",
           value = as.character(wind_h$speed)),
    tibble(hour = wind_h$hour, metric = "Dir. vento",
           value = dir_arrow(wind_h$dir, from = TRUE)),
    metrics_long
  )
}

metric_order <- c("Vento (km/h)", "Dir. vento",
                  "SISCORAR (km/h)", "Dir. SISCORAR",
                  "Boia (km/h)", "Dir. Boia")
all_hours <- sort(unique(metrics_long$hour))

metrics_wide <- metrics_long |>
  mutate(
    metric = factor(metric, levels = metric_order),
    hour = factor(hour, levels = all_hours)
  ) |>
  arrange(metric, hour) |>
  pivot_wider(names_from = hour, values_from = value, values_fill = "\u2014")

metrics_wide |>
  gt::gt() |>
  gt::cols_label(metric = "") |>
  gt::tab_caption(paste("Correntes SISCORAR + Boia 515 + Vento \u2014", date_short)) |>
  gt::tab_options(
    table.font.size = gt::px(12),
    data_row.padding = gt::px(2),
    column_labels.padding = gt::px(4)
  )
```

```{r match-grib, include = FALSE}
# Extract GRIB current at each segment's midpoint and nearest hour
mid_x <- (fast500$start_x + fast500$end_x) / 2
mid_y <- (fast500$start_y + fast500$end_y) / 2

mid_pts <- sf::st_as_sf(
  tibble::tibble(x = mid_x, y = mid_y),
  coords = c("x", "y"),
  crs = sf::st_crs(records_sf)
) |>
  sf::st_transform(4326)

mid_vect <- terra::vect(mid_pts)

# Find nearest GRIB hour for each segment
seg_hour_utc <- as.numeric(format(fast500$start_time, "%H", tz = "UTC"))
seg_hour_idx <- pmin(pmax(seg_hour_utc, 0), n_hours - 1) + 1

# Extract U and V from cropped study layers at all midpoints
u_all <- as.matrix(terra::extract(u_study, mid_vect))
v_all <- as.matrix(terra::extract(v_study, mid_vect))

# Column 1 is ID; columns 2:(n_hours+1) are hours 0:(n_hours-1)
row_idx <- seq_len(nrow(fast500))
col_idx <- seg_hour_idx + 1L  # +1 for the ID column

u_vals <- u_all[cbind(row_idx, col_idx)]
v_vals <- v_all[cbind(row_idx, col_idx)]

# Fill near-shore NAs: expand ocean values into land cells using focal,
# then re-extract only for segments that got NA from direct extraction
na_mask <- is.na(u_vals) | is.na(v_vals)
if (any(na_mask)) {
  fill_focal <- function(r, max_iter = 10L) {
    for (i in seq_len(max_iter)) {
      if (!any(is.na(terra::values(r)))) break
      r <- terra::focal(r, w = 11, fun = "mean", na.policy = "only", na.rm = TRUE)
    }
    r
  }

  na_hours <- unique(seg_hour_idx[na_mask])
  for (h in na_hours) {
    h_mask <- na_mask & (seg_hour_idx == h)
    u_filled <- fill_focal(u_study[[h]])
    v_filled <- fill_focal(v_study[[h]])
    u_vals[h_mask] <- terra::extract(u_filled, mid_vect[h_mask])[, 2]
    v_vals[h_mask] <- terra::extract(v_filled, mid_vect[h_mask])[, 2]
  }
  n_filled <- sum(na_mask & !(is.na(u_vals) | is.na(v_vals)))
  n_still_na <- sum(is.na(u_vals) | is.na(v_vals))
}

# Convert U,V (m/s) to speed (km/h) and direction (TO convention, degrees)
fast500$current_speed_kmh     <- sqrt(u_vals^2 + v_vals^2) * 3.6
fast500$current_direction_deg <- (atan2(u_vals, v_vals) * 180 / pi) %% 360

# Add wind + buoy current from SIMCOSTA via rolling time-join
buoy_for_match <- buoy_ip |>
  transmute(
    datetime,
    wind_direction_deg = if ("wind_direction" %in% names(buoy_ip))
      wind_direction else NA_real_,
    wind_speed_kmh = if ("wind_speed" %in% names(buoy_ip))
      wind_speed * 3.6 else NA_real_,
    buoy_current_direction_deg = if ("current_direction" %in% names(buoy_ip))
      current_direction else NA_real_,
    buoy_current_speed_kmh = if ("current_speed_kmh" %in% names(buoy_ip))
      current_speed_kmh else NA_real_
  )

matched <- match_buoy_to_segments(fast500, buoy_for_match)
```

```{r apparent, include = FALSE}
# SISCORAR current is in current_speed_kmh / current_direction_deg (primary)
conditions <- apparent_conditions(matched, impute_missing_wind = !has_wind)

# Buoy current classification (secondary source)
if (has_buoy_current &&
    !all(is.na(conditions$buoy_current_speed_kmh))) {
  buoy_rel <- relative_current(
    conditions$bearing_deg,
    conditions$buoy_current_direction_deg
  )
  buoy_angle_rad <- buoy_rel$current_angle_deg * pi / 180
  conditions$buoy_current_angle_deg <- buoy_rel$current_angle_deg
  conditions$buoy_current_class <- buoy_rel$current_class
  conditions$buoy_current_component_kmh <-
    conditions$buoy_current_speed_kmh * cos(buoy_angle_rad)
}
```


```{r polar-plots, fig.height = 5, fig.width = 14, fig.cap = "Corrente (SISCORAR e Boia) e vento relativos ao rumo do trecho mais rápido."}
# --- SISCORAR current polar ---
siscorar_polar <- conditions |>
  as_tibble() |>
  filter(!is.na(current_speed_kmh)) |>
  mutate(current_relative_deg = (current_direction_deg - bearing_deg) %% 360)

siscorar_r_max <- max(5, max(siscorar_polar$current_speed_kmh, na.rm = TRUE))

p_siscorar <- ggplot(siscorar_polar, aes(x = current_relative_deg, y = current_speed_kmh)) +
  geom_point(aes(colour = avg_speed_kmh), size = 3) +
  ggrepel::geom_text_repel(aes(label = fullname_athlete), size = 2.5, max.overlaps = 20) +
  coord_polar(start = 0, direction = -1) +
  scale_x_continuous(
    limits = c(0, 360), breaks = c(0, 90, 180, 270),
    labels = c("A favor", "90\u00b0", "Contra", "270\u00b0")
  ) +
  scale_y_continuous(limits = c(0, siscorar_r_max)) +
  scale_colour_viridis_c(option = "plasma", name = "Vel. (km/h)") +
  labs(title = "Corrente (SISCORAR)", x = NULL, y = "Vel. corrente (km/h)") +
  theme_minimal(base_size = 10)

# --- Buoy current polar ---
panels <- list(p_siscorar)

if (has_buoy_current &&
    "buoy_current_speed_kmh" %in% names(conditions) &&
    any(!is.na(conditions$buoy_current_speed_kmh))) {
  buoy_polar <- conditions |>
    as_tibble() |>
    filter(!is.na(buoy_current_speed_kmh)) |>
    mutate(buoy_relative_deg = (buoy_current_direction_deg - bearing_deg) %% 360)

  buoy_r_max <- max(5, max(buoy_polar$buoy_current_speed_kmh, na.rm = TRUE))

  p_buoy <- ggplot(buoy_polar, aes(x = buoy_relative_deg, y = buoy_current_speed_kmh)) +
    geom_point(aes(colour = avg_speed_kmh), size = 3) +
    ggrepel::geom_text_repel(aes(label = fullname_athlete), size = 2.5, max.overlaps = 20) +
    coord_polar(start = 0, direction = -1) +
    scale_x_continuous(
      limits = c(0, 360), breaks = c(0, 90, 180, 270),
      labels = c("A favor", "90\u00b0", "Contra", "270\u00b0")
    ) +
    scale_y_continuous(limits = c(0, buoy_r_max)) +
    scale_colour_viridis_c(option = "plasma", name = "Vel. (km/h)") +
    labs(title = "Corrente (Boia)", x = NULL, y = "Vel. corrente (km/h)") +
    theme_minimal(base_size = 10)

  panels <- c(panels, list(p_buoy))
}

# --- Wind polar ---
if (has_wind) {
  wind_polar <- conditions |>
    as_tibble() |>
    filter(!is.na(wind_speed_kmh)) |>
    mutate(wind_relative_deg = (wind_direction_deg + 180 - bearing_deg) %% 360)

  wind_r_max <- max(30, max(wind_polar$wind_speed_kmh, na.rm = TRUE))

  p_wind <- ggplot(wind_polar, aes(x = wind_relative_deg, y = wind_speed_kmh)) +
    geom_point(aes(colour = avg_speed_kmh), size = 3) +
    ggrepel::geom_text_repel(aes(label = fullname_athlete), size = 2.5, max.overlaps = 20) +
    coord_polar(start = 0, direction = -1) +
    scale_x_continuous(
      limits = c(0, 360), breaks = c(0, 90, 180, 270),
      labels = c("A favor", "90\u00b0", "Contra", "270\u00b0")
    ) +
    scale_y_continuous(limits = c(0, wind_r_max)) +
    scale_colour_viridis_c(option = "plasma", name = "Vel. (km/h)") +
    labs(title = "Vento (Boia)", x = NULL, y = "Vel. vento (km/h)") +
    theme_minimal(base_size = 10)

  panels <- c(panels, list(p_wind))
}

wrap_plots(panels, ncol = length(panels)) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

### Classificação: 500m mais rápidos

```{r league}
league <- build_league_table(conditions, athlete_col = "fullname_athlete")
league_fmt <- format_league(league, top_n = 15)

wind_class_pt <- c(
  calm = "calmo", headwind = "contra", tailwind = "a favor",
  crosswind_right = "lateral dir.", crosswind_left = "lateral esq."
)
current_class_pt <- c(
  following = "a favor", opposing = "contra",
  cross_right = "lateral dir.", cross_left = "lateral esq."
)

league_tbl <- league_fmt |>
  mutate(
inicio=format.Date(lubridate::with_tz(datetime, "America/Recife"), "%H:%M"),
    tempo = sprintf("%d:%02d", floor(predicted_time_sec / 60),
                    round(predicted_time_sec %% 60)),
    avg_speed_kmh = round(avg_speed_kmh, 1),
    vento = paste0(wind_class_pt[wind_class], " (",
                   round(wind_component_kmh, 1), " km/h)"),
    corrente_siscorar = paste0(current_class_pt[current_class], " (",
                               round(current_component_kmh, 1), " km/h)")
  )

cols_select <- c("rank", "fullname_athlete", 
"inicio", 
"tempo", "avg_speed_kmh",
                 "vento", "corrente_siscorar")
cols_label <- list(
  rank = "#", fullname_athlete = "Atleta", 
  inicio="Início",
  tempo = "Tempo",
  avg_speed_kmh = "Velocidade (km/h)", vento = "Vento",
  corrente_siscorar = "Corrente SISCORAR"
)

if (has_buoy_current &&
    "buoy_current_class" %in% names(league_fmt)) {
  league_tbl <- league_tbl |>
    mutate(
      corrente_boia = paste0(current_class_pt[buoy_current_class], " (",
                             round(buoy_current_component_kmh, 1), " km/h)")
    )
  cols_select <- c(cols_select, "corrente_boia")
  cols_label$corrente_boia <- "Corrente Boia"
}

league_tbl |>
  select(all_of(cols_select)) |>
  gt::gt() |>
  gt::cols_label(!!!cols_label) |>
  gt::tab_caption(paste("Classificação: 500 m mais rápidos em", date_short)) |>
  gt::tab_options(
    table.font.size = gt::px(12),
    data_row.padding = gt::px(2),
    column_labels.padding = gt::px(4)
  ) |>
  gt::opt_interactive(page_size_default = 100) |>
  gt::cols_width(fullname_athlete~gt::px(200), rank~gt::px(30),
  tempo~gt::px(60), avg_speed_kmh~gt::px(90))
```

### Resumo

```{r summary-stats, results = "asis"}
# Current summary from SISCORAR (training period)
grib_summary <- grib_training |>
  summarise(
    mean_speed = round(mean(current_speed_kmh, na.rm = TRUE), 2),
    max_speed  = round(max(current_speed_kmh, na.rm = TRUE), 2)
  )

# Circular mean direction from U,V means
training_idx <- which(
  grib_times >= records_time_range[1] &
  grib_times <= records_time_range[2]
)
if (length(training_idx) == 0) training_idx <- seq_len(n_hours)
u_train_mean <- mean(u_means[training_idx], na.rm = TRUE)
v_train_mean <- mean(v_means[training_idx], na.rm = TRUE)
mean_current_dir <- round((atan2(u_train_mean, v_train_mean) * 180 / pi) %% 360, 0)

avg_dur_min <- mean(paddlers$duration_min, na.rm = TRUE)
avg_dur_fmt <- sprintf("%d:%02d", floor(avg_dur_min / 60), round(avg_dur_min %% 60))

winner      <- league_fmt$fullname_athlete[1]
winner_sec  <- league_fmt$predicted_time_sec[1]
winner_time <- sprintf("%d:%02d", floor(winner_sec / 60), round(winner_sec %% 60))
winner_kmh  <- round(league_fmt$avg_speed_kmh[1], 1)

if (has_wind) {
  wind_summary <- buoy_wind |>
    summarise(
      mean_speed = round(mean(wind_speed_kmh, na.rm = TRUE), 1),
      max_speed  = round(max(wind_speed_kmh, na.rm = TRUE), 1),
      mean_dir   = round(mean(wind_direction, na.rm = TRUE), 0)
    )
  wind_line <- sprintf(
    "- **Vento (Boia 515):** média %s km/h (máx %s), predominante de %s°",
    wind_summary$mean_speed, wind_summary$max_speed, wind_summary$mean_dir
  )
} else {
  wind_line <- "- **Vento:** sem dados disponíveis (imputado como zero)"
}

current_match_line <- if (exists("na_mask") && any(na_mask)) {
  sprintf(
    "- **SISCORAR por trecho:** %d/%d extraídos diretamente, %d interpolados (próximo da costa)",
    sum(!na_mask), length(na_mask), n_filled
  )
} else {
  sprintf(
    "- **SISCORAR por trecho:** %d/%d extraídos diretamente",
    nrow(fast500), nrow(fast500)
  )
}

if (has_buoy_current) {
  buoy_current_summary <- buoy_current |>
    summarise(
      mean_speed = round(mean(current_speed_kmh, na.rm = TRUE), 2),
      max_speed  = round(max(current_speed_kmh, na.rm = TRUE), 2),
      mean_dir   = round(mean(current_direction, na.rm = TRUE), 0)
    )
  buoy_current_line <- sprintf(
    "- **Corrente (Boia 515):** média %s km/h (máx %s), fluindo para %s°",
    buoy_current_summary$mean_speed, buoy_current_summary$max_speed,
    buoy_current_summary$mean_dir
  )
} else {
  buoy_current_line <- "- **Corrente (Boia 515):** sem dados disponíveis"
}

cat(sprintf(
  "**Resumo do treino:**\n\n
- **Data:** %s
- **Atletas na água:** %d
- **Duração média:** %s (h:mm)
%s
%s
- **500 m mais rápido:** %s em %s (%s km/h)\n",
  date_label,
  n_paddlers,
  avg_dur_fmt,
  wind_line,
  #grib_summary$mean_speed, #grib_summary$max_speed, mean_current_dir,
  buoy_current_line,
  #current_match_line,
  winner, winner_time, winner_kmh
))
```
